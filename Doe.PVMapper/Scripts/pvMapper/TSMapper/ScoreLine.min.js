var pvMapper;(function(n){var t=function(){function n(n,t,i,r,u,f,e){this.title=n,this.description=t,this.category=i,this.weight=r,this.active=u,this.scoreUtility=f,this.rateTable=e}return n}(),i;n.DBScore=t,i=function(){function i(t){var i=this;this.weight=0,this.scores=[],this.active=!0,this.scoreChangeEvent=new n.Event,this.updatingScoresEvent=new n.Event,this.self=this,this.title=typeof t.title=="string"?t.title:"Unnamed Tool",t.description&&(this.description=t.description),this.category=typeof t.category=="string"?t.category:"Other",$.isFunction(t.onSiteChange)&&(this.onSiteChange=function(){return t.onSiteChange.apply(i,arguments)}),$.isFunction(t.getStarRatables)&&(this.getStarRatables=function(){return t.getStarRatables.apply(i,arguments)}),$.isFunction(t.showConfigWindow)&&(this.showConfigWindow=function(){t.showConfigWindow.apply(i,arguments)}),this.valueChangeHandler=function(n){n.score.setUtility(i.getUtilityScore(n.newValue)),i.scoreChangeEvent.fire(i,n)},n.siteManager.siteAdded.addHandler(function(n){i.addScore(n)}),n.siteManager.siteRemoved.addHandler(function(n){i.onSiteRemove(n)}),t.scoreUtilityOptions==undefined&&(t.scoreUtilityOptions={functionName:"random",functionArgs:{className:"Random"},iconURL:null}),this.utilargs=new n.MinMaxUtilityArgs(0,10,"",""),this.scoreUtility=new n.ScoreUtility(t.scoreUtilityOptions),this.loadAllSites(),this.weight=this.weight<0?typeof t.weight=="number"?t.weight:10:this.weight}return i.prototype.getUtilityScore=function(n){return this.scoreUtility.run(n)},i.prototype.getWeight=function(){return this.weight},i.prototype.setWeight=function(n){this.weight=n,this.scoreChangeEvent.fire(self,undefined),this.saveScore()},i.prototype.addScore=function(t){var i=new n.Score(t);i.siteChangeEvent.addHandler(this.onSiteChange),i.valueChangeEvent.addHandler(this.valueChangeHandler),this.scores.push(i);try{this.onSiteChange(undefined,i)}catch(r){console&&console.error(r)}return i},i.prototype.updateScores=function(){this.scores.forEach(function(n){var t=n.value;n.setUtility(this.getUtilityScore(n.value)),this.scoreChangeEvent.fire(this,{score:n,oldValue:t,newValue:n.value})},this)},i.prototype.loadAllSites=function(){var t=this,i=n.siteManager.getSites();$.each(i,function(n,i){t.addScore(i)})},i.prototype.onSiteRemove=function(n){var t,i;for(console.log("Attempting to remove a site/score from the scoreline"),t=0;t<this.scores.length;t++)if(i=this.scores[t],i.site==n){i.siteChangeEvent.removeHandler(this.onSiteChange),i.valueChangeEvent.removeHandler(this.valueChangeHandler),this.scores.splice(t,1),this.scoreChangeEvent.fire(self,undefined);break}},i.prototype.toJSON=function(){return{title:this.title,weight:this.weight,description:this.description,category:this.category,scoreUtility:this.scoreUtility,scores:this.scores}},i.prototype.putScore=function(){var i=this;if(n.ClientDB.db)try{var u=n.ClientDB.db.transaction(n.ClientDB.STORE_NAME,"readwrite"),f=u.objectStore(n.ClientDB.STORE_NAME),r=new t(i.title,i.description,i.category,i.weight,i.active,i.scoreUtility,i.getStarRatables()),o=f.add(r,r.title)}catch(e){console.log("pubDBObject failed, cause: "+e.message)}},i.prototype.saveScore=function(){if(n.ClientDB.db!=null)try{this.putScore()}catch(t){console.log("Error: "+t.message)}},i.prototype.getScore=function(){var t=this;if(n.ClientDB.db){var r=n.ClientDB.db.transaction(n.ClientDB.STORE_NAME,"readonly"),u=r.objectStore(n.ClientDB.STORE_NAME),i=u.get(t.title);i.onsuccess=function(){i.result!=undefined&&(t.title=i.result.title,t.description=i.result.description,t.category=i.result.category,t.weight=i.result.weight,t.active=i.result.active,t.scoreUtility.functionName=i.result.scoreUtility.functionName,t.scoreUtility.functionArgs=i.result.scoreUtility.functionArgs,t.scoreUtility.iconURL=i.result.scoreUtility.iconURL,t.scoreUtility.fCache=i.result.scoreUtility.fCache,t.updateScores())}}},i.prototype.loadScore=function(){if(n.ClientDB.db!=null)try{this.getScore()}catch(t){console.log("Error: "+t.message)}},i}(),n.ScoreLine=i})(pvMapper||(pvMapper={}))