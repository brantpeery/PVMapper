var INLModules;(function(n){var t=function(){function n(){var n=this,t;this.starRatingHelper=new pvMapper.StarRatingHelper({defaultStarRating:3}),this.soilRestUrl="http://server.arcgisonline.com/ArcGIS/rest/services/Specialty/Soil_Survey_Map/MapServer/",this.soilSurveyQueryUrl="http://server.arcgisonline.com/ArcGIS/rest/services/Specialty/Soil_Survey_Map/MapServer/0/query",this.nearestFeatureCache={},t=new pvMapper.Module({id:"SoilModule",author:"Leng Vang, INL",version:"0.1.ts",activate:function(){n.addMap()},deactivate:function(){n.removeMap()},destroy:null,init:null,scoringTools:[{activate:null,deactivate:null,destroy:null,init:null,title:"Soil",description:"Overlapping soil types, using the U.S. General Soil Map from the Department of Agriculture's Natural Resources Conservation Service hosted by arcgisonline.com",category:"Geography",onSiteChange:function(t,i){n.updateScore(i)},getStarRatables:function(){return n.starRatingHelper.starRatings},setStarRatables:function(t){n.starRatingHelper.starRatings=t},scoreUtilityOptions:{functionName:"linear",functionArgs:new pvMapper.MinMaxUtilityArgs(0,5,"stars")},weight:10}],infoTools:null})}return n.prototype.addMap=function(){this.soilLayer=new OpenLayers.Layer.ArcGIS93Rest("Soil Type",this.soilRestUrl+"export",{layers:"show:0",format:"gif",srs:"3857",transparent:"true"}),this.soilLayer.setOpacity(.3),this.soilLayer.epsgOverride="3857",this.soilLayer.setVisibility(!1),pvMapper.map.addLayer(this.soilLayer)},n.prototype.removeMap=function(){pvMapper.map.removeLayer(this.soilLayer,!1)},n.prototype.updateScore=function(n){this.updateScoreFromWeb(n)},n.prototype.updateScoreFromWeb=function(n){var i=this,t=OpenLayers.Format.GeoJSON.prototype.write(n.site.geometry,!1),r,u;t=t.replace('"type":"Polygon",',""),t=t.replace('"coordinates":','"rings":'),r=new OpenLayers.Protocol.Script({url:this.soilSurveyQueryUrl,params:{f:"json",geometryType:"esriGeometryPolygon",geometry:t,returnGeometry:!1},format:new OpenLayers.Format.EsriGeoJSON,parseFeatures:function(n){return n.features},callback:function(t){t.success()?(i.nearestFeatureCache[n.site.id]=t.features||[],i.updateScoreFromCache(n)):(n.popupMessage="Request error "+t.error.toString(),n.updateValue(Number.NaN))}}),u=r.read()},n.prototype.updateScoreFromCache=function(n){var u=this.nearestFeatureCache[n.site.id],i=[],r,t,f;if(u)for(r=0;r<u.length;r++)if(t=u[r].attributes.muname,t&&i.indexOf(t)<0&&(i.push(t),typeof this.starRatingHelper.starRatings[t]=="undefined"))switch(u[r].attributes.muhelcl){case"Highly erodible land":this.starRatingHelper.starRatings[t]=2;break;case"Potentially highly erodible land":this.starRatingHelper.starRatings[t]=3;break;case"Not highly erodible land":this.starRatingHelper.starRatings[t]=4}i.length>0?(f=this.starRatingHelper.sortRatableArray(i),n.popupMessage=f,n.updateValue(this.starRatingHelper.starRatings[i[0]])):(n.popupMessage="No soil data here.",n.updateValue(Number.NaN))},n}(),i;n.SoilModule=t,i=new n.SoilModule})(INLModules||(INLModules={}))